#!/bin/bash

# parse port numbers with awk from masscan results
sed -n '/port/ s/.*\: \([0-9][0-9]*\).*/\1/p' *masscan-results > ports.txt

# remove duplicates from ports.txt
sort ports.txt | uniq > uniq-ports.txt

# remove original ports.txt
rm ports.txt 

# convert column into row
echo $(cat uniq-ports.txt) > uniq-port-rows.txt 

# remove uniq-ports.txt
rm uniq-ports.txt

# insert commas after port numbers no whitespace
sed -e 's/\s\+/,/g' uniq-port-rows.txt > commas.txt

# assign port number variables to passed to nmap 
ports=$(sed -e 's/\s\+/,/g' uniq-port-rows.txt)

# create bash script to see what nmap is doing
touch nmap-eyewitness-scan.sh

# add content to bash script with variable
echo '#!/bin/bash' > nmap-eyewitness-scan.sh
echo "" >> nmap-eyewitness-scan.sh
echo '#service scan with list of ip addresses' >> nmap-eyewitness-scan.sh
echo nmap -Pn -sV -p "$ports" -iL *ips-online.txt -oA {{ target }}-{{ ansible_date_time.date }}-SERVICE-results-date >> nmap-eyewitness-scan.sh
echo ""  >> nmap-eyewitness-scan.sh
echo '# get screenshots based on open ports with eyewitness' >> nmap-eyewitness-scan.sh
echo /home/{{ user_name }}/EyeWitness/Python/EyeWitness.py --web --no-prompt --add-https-ports "$ports" -f *hosts-online.txt -d {{ target }}-{{ ansible_date_time.date }}-Eyewitness-HTTPS-results >> nmap-eyewitness-scan.sh
echo ""  >> nmap-eyewitness-scan.sh
echo /home/{{ user_name }}/EyeWitness/Python/EyeWitness.py --web --no-prompt --add-http-ports "$ports" -f *hosts-online.txt -d {{ target }}-{{ ansible_date_time.date }}-Eyewitness-HTTP-results >> nmap-eyewitness-scan.sh
echo "" >> nmap-eyewitness-scan.sh
echo '#convert xml output to html' >> nmap-eyewitness-scan.sh
echo 'xsltproc {{ target }}-{{ ansible_date_time.date }}-NMAP-SERVICE-results.xml -o {{ target }}-{{ ansible_date_time.date }}-NMAP-SERVICE-results.html' >> nmap-eyewitness-scan.sh
# make script executable
chmod 755 nmap-eyewitness-scan.sh

